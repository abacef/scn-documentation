<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Proxmox Deployment Guide - Vaultwarden - Seattle Community Network Docs</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Proxmox Deployment Guide - Vaultwarden";
        var mkdocs_page_input_path = "infrastructure/proxmox-vaultwarden-deployment.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Seattle Community Network Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Faq</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/connection/">How do I get Internet?</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/what/">What is a Community Network?</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/why/">Why have a Community Network?</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/about/">What is the Seattle Community Network?</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/how/">How does SCN Work?</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/site/">What is this site?</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/help/">How can I Help?</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Community</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../community/join/">Join Us</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../community/mission-vision-values/">Mission, Vision, Values</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../community/code-of-conduct/">Code of Conduct</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../community/join/">Join Us</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../community/partners/">Our Partners</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../community/tech-help/">Community Tech Help</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../community/community-networking-toolkit/">Community Networking Toolkit</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Learn</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../learn/wireless-communication/">Wireless Communication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../learn/cable-crimping/">Crimping Ethernet Cables</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../learn/lte-networks/">LTE Networks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../learn/networking/">Networking</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Infrastructure</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../hardware/">Hardware Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../software/">Software Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../peering/">Public ASN Peering</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../librenms-manager-setup/">Network Monitoring 1. LibreNMS Network Manager Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../librenms-setup/">Network Monitoring 2. LibreNMS Agent Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../epc-setup/">Step 1. LTE Core Network Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../sas-setup/">Step 2. eNodeB and SAS Setup</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Proxmox Deployment Guide - Vaultwarden</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Librenms</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../librenms/deploy/">Deploying</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../librenms/upgrade/">Upgrading</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../librenms/backup/">Backing Up</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Contribute</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../contribute/contribute/">Contribute to SCN Docs</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Seattle Community Network Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Infrastructure</li>
      <li class="breadcrumb-item active">Proxmox Deployment Guide - Vaultwarden</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h3 id="deployed-by-esther-jang-paul-phillion-rudra-singh">Deployed by: Esther Jang, Paul Phillion, Rudra Singh</h3>
<hr />
<h2 id="section-1-what-is-proxmox">Section 1: What is Proxmox?</h2>
<ul>
<li><strong>Proxmox VE (Virtual Environment)</strong> is an open-source server management platform designed to deploy and manage virtual machines (VMs) and containers.</li>
<li>It integrates KVM hypervisor and LXC containers, enabling users to manage virtual infrastructure through a web-based interface.</li>
</ul>
<h2 id="section-2-access-requirements-for-proxmox-ve-at-seattle-community-network">Section 2: Access Requirements for Proxmox VE at Seattle Community Network</h2>
<ul>
<li>To submit a request for a SCN self-hosted Proxmox VM on our private cloud, please fill out <a href="https://docs.google.com/forms/d/e/1FAIpQLSf6NYZHTfxi_hcQM1DWJ8mhgJDl-iiqRL4yTQG_x1az6XEfEQ/viewform?usp=sf_link">this form</a>.</li>
<li>If you are working on a project for SCN and need access to the Proxmox VE, please continue reading.</li>
<li>Next, you will need access to the OpenVPN. Proxmox VE can only be accessed on the VPN. Specific details can be obtained from the SCN discord. Once connected to the VPN, a specific IP will be provided for you to access the Proxmox VE, where you can input your credentials.</li>
</ul>
<h2 id="section-3-setting-up-your-vm">Section 3: Setting up your VM</h2>
<ul>
<li>
<h3 id="install-ssh">Install SSH</h3>
</li>
<li>
<h3 id="install-keys">Install Keys</h3>
</li>
<li>
<h3 id="test-ssh-cli">Test SSH CLI</h3>
</li>
</ul>
<h2 id="section-4-ssh-troubleshooting">Section 4: SSH Troubleshooting</h2>
<ul>
<li>Please let the SCN discord know if you have trouble SSH'ing in. A useful command during setup was <code>sudo ufw status</code>. If it is active, use <code>ufw disable</code>. The expected status should be inactive. If that still doesn’t work, try restarting the VM from the Proxmox VE.</li>
</ul>
<h2 id="section-5-beginning-deployment-vaultwarden">Section 5: Beginning Deployment: Vaultwarden</h2>
<pre><code class="language-bash">docker pull vaultwarden/server:latest
docker run -d --name vaultwarden -v /vw-data/:/data/ --restart unless-stopped -p 80:80 vaultwarden/server:latest
</code></pre>
<h2 id="section-6-docker-compose">Section 6: Docker Compose</h2>
<ul>
<li>Create a Docker Compose file:</li>
</ul>
<pre><code class="language-yaml">version: &quot;3&quot;

services:
  vaultwarden:
    container_name: vaultwarden
    hostname: vaultwarden9
    ports:
      - &quot;127.0.0.1:8080:80&quot;
    environment:
      - LOG_FILE=/log/access.log
      - LOG_LEVEL=info
      - EXTENDED_LOGGING=true
    image: vaultwarden/server:latest
    restart: unless-stopped
    volumes:
      - /opt/vw-data:/data
      - /var/log/vw:/log
</code></pre>
<ul>
<li>To start and run your container application in detached mode, use:</li>
</ul>
<pre><code class="language-bash">docker-compose up -d
docker-compose start
docker-compose stop
docker-compose restart
</code></pre>
<h2 id="section-7-azure-dns">Section 7: Azure DNS</h2>
<ul>
<li>For this deployment, we're utilizing a public IP address. This address must be configured within Azure DNS to point to our chosen domain name.</li>
<li>Navigate to Home - Microsoft Azure with your account.</li>
<li>Open “DNS zones”. If you were using a private IP, you would use “Private DNS zones”.</li>
<li>We will be creating a subdomain under seattlecommunitynetwork.org.</li>
<li>Click on that, and under DNS management, click recordsets, and click add.</li>
<li>Insert the beginning of the subdomain name, which in our case is “vaultwarden”.</li>
<li>Below, under IP address, insert your IP, and create your new subdomain.</li>
</ul>
<h2 id="section-8-enabling-nginx">Section 8: Enabling Nginx</h2>
<pre><code class="language-bash">sudo apt update
sudo apt install nginx
sudo systemctl enable nginx
sudo systemctl start nginx
</code></pre>
<ul>
<li>Next, go to <code>/etc/nginx/sites-enabled/default</code>. Delete everything inside <code>default</code> and paste this:</li>
</ul>
<pre><code class="language-nginx"># The `upstream` directives ensure that you have a http/1.1 connection
# This enables the keepalive option and better performance
#
# Define the server IP and ports here.
upstream vaultwarden-default {
  zone vaultwarden-default 64k;
  server 127.0.0.1:8080;
  keepalive 2;
}

# Needed to support websocket connections
# See: https://nginx.org/en/docs/http/websocket.html
# Instead of &quot;close&quot; as stated in the above link we send an empty value.
# Else all keepalive connections will not work.
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      &quot;&quot;;
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name vaultwarden.seattlecommunitynetwork.org;

    if ($host = vaultwarden.seattlecommunitynetwork.org) {
        return 301 https://$host$request_uri;
    }
    return 404;
}

server {
    # For older versions of nginx appened http2 to the listen line after ssl and remove `http2 on`
    listen 443 ssl;
    listen [::]:443 ssl;
   # http2 on;
    server_name vaultwarden.seattlecommunitynetwork.org;

    # Specify SSL Config when needed
    ssl_certificate /etc/path...;
    ssl_certificate_key /etc/path...;
    ssl_trusted_certificate /etc/path...;

    client_max_body_size 525M;

    location / {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://vaultwarden-default;
    }

    # Optionally add extra authentication besides the ADMIN_TOKEN
    # Remove the comments below `#` and create the htpasswd_file to have it active
    #
    #location /admin {
    # See: https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/
      #auth_basic &quot;Administrator's Area&quot;;
      #3auth_basic_user_file /path/to/htpasswd_file;

      #proxy_http_version 1.1;
      #proxy_set_header Upgrade $http_upgrade;
      #proxy_set_header Connection $connection_upgrade;

      #proxy_set_header Host $host;
      #proxy_set_header X-Real-IP $remote_addr;
      #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      #proxy_set_header X-Forwarded-Proto $scheme;
      #proxy_pass http://vaultwarden-default;
    }
}
</code></pre>
<h2 id="section-9-obtain-ssl-certificates">Section 9: Obtain SSL Certificates</h2>
<pre><code class="language-bash">sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d vaultwarden.seattlecommunitynetwork.org
</code></pre>
<ul>
<li>Certbot will modify your Nginx configuration to handle HTTPS and redirect from HTTP to HTTPS.</li>
<li>Ensure that you copy the file paths provided at the conclusion of the certbot process into the default nginx configuration file, replacing the corresponding comments with these paths.</li>
</ul>
<h2 id="section-10-ensure-everything-is-running">Section 10: Ensure Everything is Running</h2>
<pre><code class="language-bash">sudo systemctl status nginx
</code></pre>
<h2 id="section-11-additional-features">Section 11: Additional Features</h2>
<ul>
<li>Enabling admin panel:</li>
</ul>
<p>Go back to <code>/etc/nginx/sites-enabled/default</code> and uncomment the admin section at the bottom. Follow directions at <a href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/">Nginx Admin Guide</a> to encrypt your admin password as a <code>.env</code> file (preferably using argon CLI).</p>
<p>Once done, make sure you create a <code>.env</code> file in the directory where the compose file is with <code>VAULTWARDEN_ADMIN_TOKEN=[insert your hashed admin token]</code>.</p>
<p>Then in your compose, add these two lines under environment:</p>
<pre><code class="language-yaml">- ADMIN_TOKEN=${VAULTWARDEN_ADMIN_TOKEN}
- DOMAIN=https://vaultwarden.seattlecommunitynetwork.org
</code></pre>
<p>Restart the container and try logging into <a href="https://vaultwarden.seattlecommunitynetwork.org/admin">https://vaultwarden.seattlecommunitynetwork.org/admin</a>.</p>
<p>Once logged in, SMTP and 2FA enabling settings can be configured on the home page.</p>
<h2 id="section-12-data-backup">Section 12: Data Backup</h2>
<ul>
<li>Enabling backups for Vaultwarden is a simple process. Please review the attached backup bash script, which facilitates the transfer of Vaultwarden data to another virtual machine. Additionally, there is a cleanup bash script designed to retain only the most recent file in the other VM, deleting all others. Feel free to modify the scripts as necessary to suit your specific requirements.</li>
</ul>
<p>Backup script:</p>
<pre><code class="language-bash">#!/bin/bash

docker-compose down
datestamp=$(date +%m-%d-%Y)
zip -9 -r /home/scn/backups/${datestamp}.zip /opt/vw-data*
scp -i ~/.ssh-comm/id_rsa /home/scn/backups/${datestamp}.zip azureuser@[IP address]:~/backups/
docker-compose up -d
</code></pre>
<p>Cleanup Script:</p>
<pre><code class="language-bash">#!/bin/bash

# Define the directory containing backup files
backup_dir=~/backups

# Go to the backup directory
cd &quot;$backup_dir&quot; || exit

# Find and delete older backup files (excluding the latest day)
find . -type f -name '*.zip' ! -mtime -1 -exec rm {} +

# Exit
exit 0
</code></pre>
<h2 id="section-13-using-the-backup">Section 13: Using the Backup</h2>
<p>To restore a data backup to the original virtual machine, simply unzip the file and delete the existing contents of <code>/opt/vw-data</code>. Then, transfer the contents of your zip file into this directory. Perform a quick restart of the container, and you will have successfully restored the version of the backup you selected.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../sas-setup/" class="btn btn-neutral float-left" title="Step 2. eNodeB and SAS Setup"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../librenms/deploy/" class="btn btn-neutral float-right" title="Deploying">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../sas-setup/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../librenms/deploy/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
